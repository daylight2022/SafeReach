# SafeReach 在外人员联系提醒功能完整说明文档

## 📋 目录
1. [功能概述](#功能概述)
2. [核心概念](#核心概念)
3. [基准日期确定规则](#基准日期确定规则)
4. [提醒生成规则](#提醒生成规则)
5. [完整场景示例](#完整场景示例)
6. [防重复机制](#防重复机制)
7. [执行流程](#执行流程)

---

## 功能概述

SafeReach 提醒系统是一个针对**在外人员（休假中人员）**的智能联系提醒管理系统。

### 核心目标
- ✅ **只对正在休假中的人员**（status='active'）进行联系提醒
- ✅ 确保定期与在外人员保持联系
- ✅ 针对不同休假时长提供差异化的提醒策略
- ✅ 避免重复提醒，确保每人每次只有一条未处理提醒

### 关键特性
- ✅ 只处理在外人员（休假中）
- ✅ 统一的提醒生成逻辑
- ✅ 智能基准日期计算
- ✅ 短假特殊处理（3-6天）
- ✅ 休假结束前提醒
- ✅ 防重复机制
- ❌ 不对在岗人员提醒
- ❌ 取消休假前提醒（人在单位不需要）

### 重要说明
⚠️ **本系统只针对当前正在休假的人员生成提醒，休假结束后不再生成任何提醒。**

---

## 核心概念

### 1. 基准日期（Base Date）
用于计算"距离上次联系天数"的起始日期。根据不同情况智能确定。

### 2. 联系阈值（Contact Threshold）
- **建议阈值（suggestThreshold）**：默认 7 天，达到后创建 medium 优先级提醒
- **紧急阈值（urgentThreshold）**：默认 10 天，达到后创建 high 优先级提醒

### 3. 提醒类型（Reminder Type）
- `overdue`：超期未联系提醒
- `during`：休假期间提醒（用于短假）
- `ending`：休假结束前提醒

### 4. 优先级（Priority）
- `high`：紧急提醒（红色，达到紧急阈值）
- `medium`：建议提醒（黄色，达到建议阈值或特殊情况）

---

## 基准日期确定规则

⚠️ **前提：所有处理的人员都是当前正在休假中的人员**

```
┌─────────────────────────────────────────┐
│    基准日期计算流程（仅休假中人员）        │
└─────────────────────────────────────────┘

1. 是否有 lastContactDate？
   ├─ YES → 基准日期 = lastContactDate
   └─ NO  → 继续判断

2. 比较 created_at 和 leave.start_date
   ├─ created_at < start_date → 基准日期 = start_date
   └─ created_at ≥ start_date → 基准日期 = created_at
```

### 详细说明

#### 情况1：有上次联系记录
```javascript
if (person.lastContactDate) {
  baseDate = lastContactDate
}
```
**适用场景：** 人员已被联系过，以最近一次联系日期为准  
**示例：** 休假第3天联系过，第7天再次判断时以第3天为基准

#### 情况2：无联系记录 + 人员在休假前添加
```javascript
if (person.createdAt < leave.startDate) {
  baseDate = leave.startDate  // 以休假开始日期为基准
}
```
**适用场景：** 人员先添加到系统，后来开始休假  
**示例：** Day 0添加，Day 1开始休假 → 基准日期 = Day 1

#### 情况3：无联系记录 + 人员在休假中添加
```javascript
if (person.createdAt ≥ leave.startDate) {
  baseDate = person.createdAt // 以添加日期为基准
}
```
**适用场景：** 休假已开始后才添加到系统的人员  
**示例：** Day 1开始休假，Day 5才添加 → 基准日期 = Day 5

---

## 提醒生成规则

⚠️ **前提：所有人员都是当前正在休假中的人员**

### 优先级判断流程

提醒生成按以下优先级顺序判断（满足任一条件即创建，不再判断后续）：

```
┌──────────────────────────────────────────────┐
│  提醒生成决策树（优先级从高到低）              │
│  仅针对休假中人员                              │
└──────────────────────────────────────────────┘

1. daysSinceBase ≥ urgentThreshold (默认10天)
   → 创建紧急提醒 (overdue, high) 🚨

2. daysSinceBase ≥ suggestThreshold (默认7天)
   → 创建建议提醒 (overdue, medium) 💡

3. 短假(3-6天) && daysSinceBase ≥ 3
   → 创建短假提醒 (during, medium) 🏖️

4. 明天结束休假 && daysSinceBase ≥ 5
   → 创建结束前提醒 (ending, medium) 📋

5. 不满足任何条件
   → 跳过，不创建提醒 ⏭️
```

### 规则详解

#### 规则1：紧急提醒（最高优先级）
- **触发条件**：距离基准日期 ≥ urgentThreshold（默认10天）
- **适用人员**：所有休假中人员
- **提醒类型**：overdue
- **优先级**：high
- **日志**：🚨 创建紧急提醒: 张三 (距离基准日期10天，休假13天)

#### 规则2：建议提醒
- **触发条件**：距离基准日期 ≥ suggestThreshold（默认7天）
- **适用人员**：所有休假中人员
- **提醒类型**：overdue
- **优先级**：medium
- **日志**：💡 创建建议提醒: 李四 (距离基准日期7天，休假10天)

#### 规则3：短假提醒（特殊场景）
- **触发条件**：
  - 休假总时长 3-6 天
  - 距离基准日期 ≥ 3 天
- **提醒类型**：during
- **优先级**：medium
- **日志**：🏖️ 创建短假提醒: 王五 (短假5天，距离基准日期3天)
- **设计目的**：短假不满足常规阈值，但也需要提醒联系

#### 规则4：休假结束前提醒（特殊场景）
- **触发条件**：
  - 明天是休假最后一天
  - 距离基准日期 ≥ 5 天
- **提醒类型**：ending
- **优先级**：medium
- **日志**：📋 创建休假结束前提醒: 赵六 (明日结束休假，距离基准日期5天)
- **设计目的**：休假即将结束，确保至少联系一次

---

## 完整场景示例

### 场景1：长假（13天）- 常规阈值覆盖

**人员信息：**
- 添加日期：Day 0
- 休假时间：Day 1 - Day 13
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 0:  添加人员 (created_at = Day 0)
Day 1:  休假开始 → 基准日期 = Day 1 (created_at < start_date)
Day 2:  距离基准1天 → 无提醒
Day 3:  距离基准2天 → 无提醒
...
Day 7:  距离基准6天 → 无提醒
Day 8:  距离基准7天 → 创建建议提醒 ✅ (overdue, medium)
Day 8:  用户处理提醒 → lastContactDate = Day 8, 新基准日期 = Day 8
Day 9:  距离新基准1天 → 无提醒
...
Day 12: 距离新基准4天 → 无提醒
Day 13: 距离新基准5天 + 明天结束 → 创建ending提醒 ✅ (ending, medium)
Day 14: 休假结束，状态改为completed
Day 15: 不在休假，距离上次联系1天 → 无提醒
```

**日志输出：**
```
Day 8:  💡 创建休假期间建议提醒: 张三 (距离基准日期7天，休假13天)
Day 13: 📋 创建休假结束前提醒: 张三 (明日结束休假，距离基准日期5天)
```

---

### 场景2：短假（5天）- 短假特殊处理

**人员信息：**
- 添加日期：Day 0
- 休假时间：Day 1 - Day 5
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 0:  添加人员 (created_at = Day 0)
Day 1:  休假开始 → 基准日期 = Day 1
Day 2:  距离基准1天 → 无提醒
Day 3:  距离基准2天 → 无提醒
Day 4:  距离基准3天 + 短假(5天) → 创建短假提醒 ✅ (during, medium)
Day 4:  用户未处理
Day 5:  距离基准4天 + 短假 + 有未处理提醒 → 更新提醒日期为Day 5 🔄
Day 5:  用户处理提醒 → lastContactDate = Day 5
Day 5:  距离上次0天 + 明天结束 + 不满足≥5天 → 无ending提醒
Day 6:  休假结束，状态改为completed
```

**日志输出：**
```
Day 4: 🏖️ 创建短假提醒: 李四 (短假5天，距离基准日期3天)
Day 5: 🔄 更新提醒: 李四 (休假结束前一天)
```

---

### 场景3：极短假（3天）- 短假下限

**人员信息：**
- 添加日期：Day 0
- 休假时间：Day 1 - Day 3
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 0:  添加人员 (created_at = Day 0)
Day 1:  休假开始 → 基准日期 = Day 1
Day 2:  距离基准1天 → 无提醒
Day 3:  距离基准2天 → 无提醒 (不满足短假≥3天的条件)
Day 4:  休假结束，距离基准3天 → 按常规逻辑判断（不满足7天阈值）→ 无提醒
```

**说明：** 3天假期不触发短假提醒（第3天距离基准才2天），但如果是Day 4开始距离就是3天了，不过此时休假已结束。

---

### 场景4：休假中添加的人员

**人员信息：**
- 添加日期：Day 5 (休假已开始)
- 休假时间：Day 1 - Day 14
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 1:  休假开始（人员尚未添加）
...
Day 5:  添加人员 (created_at = Day 5, 休假已进行5天)
        → 基准日期 = Day 5 (created_at ≥ start_date)
Day 6:  距离基准1天 → 无提醒
...
Day 11: 距离基准6天 → 无提醒
Day 12: 距离基准7天 → 创建建议提醒 ✅ (overdue, medium)
Day 12: 用户处理 → lastContactDate = Day 12
Day 13: 距离上次1天 + 明天结束 + 不满足≥5天 → 无ending提醒
Day 14: 休假结束
```

**日志输出：**
```
Day 12: 💡 创建休假期间建议提醒: 王五 (距离基准日期7天，休假14天)
```

---

### 场景5：短假未联系 - 最复杂情况

**人员信息：**
- 添加日期：Day 0
- 休假时间：Day 1 - Day 6
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 0:  添加人员 (created_at = Day 0)
Day 1:  休假开始 → 基准日期 = Day 1
Day 2:  距离基准1天 → 无提醒
Day 3:  距离基准2天 → 无提醒
Day 4:  距离基准3天 + 短假(6天) → 创建短假提醒 ✅ (during, medium)
Day 4:  用户未处理
Day 5:  距离基准4天 + 短假 + 有未处理提醒 + 明天结束 + 满足≥5天？
        → 距离基准4天，不满足≥5天，只更新现有提醒日期 🔄
Day 5:  用户处理提醒 → lastContactDate = Day 5
Day 6:  距离上次1天 + 明天结束 + 不满足≥5天 → 无ending提醒
Day 7:  休假结束
```

**日志输出：**
```
Day 4: 🏖️ 创建短假提醒: 孙七 (短假6天，距离基准日期3天)
Day 5: 🔄 更新提醒: 孙七 (休假结束前一天)
```

---

### 场景6：休假结束后不再提醒

**人员信息：**
- 添加日期：Day 0
- 休假时间：Day 1 - Day 5
- 联系阈值：建议7天，紧急10天

**时间线：**
```
Day 0:  添加人员
Day 1:  休假开始 → 基准日期 = Day 1
Day 4:  距离基准3天 + 短假5天 → 创建短假提醒 ✅ (during, medium)
Day 4:  用户处理提醒 → lastContactDate = Day 4
Day 5:  休假最后一天，距离上次1天 + 不满足≥5天 → 无提醒
Day 6:  休假结束（updateLeaveStatus执行，status → completed）
Day 7:  ❌ 不在休假，不再生成任何提醒
Day 11: ❌ 不在休假，不再生成任何提醒
Day 21: ❌ 不在休假，不再生成任何提醒
```

**重要说明：** 
- ⚠️ **休假结束后（status='completed'），系统不再对该人员生成任何提醒**
- 只有再次进入休假状态（status='active'），才会重新开始提醒流程
- 本系统只针对在外人员（休假中人员）进行管理

---

## 防重复机制

### 1. 每人只有一条未处理提醒

在处理每个人员前，先检查是否已有未处理提醒：

```javascript
const existingReminders = await db
  .select()
  .from(reminders)
  .where(
    and(
      eq(reminders.personId, person.personId),
      eq(reminders.isHandled, false)
    )
  )
  .limit(1);

if (existingReminders.length > 0) {
  // 只在特殊情况下更新（如休假结束前一天）
  // 否则跳过，不创建新提醒
  skippedCount++;
  continue;
}
```

### 2. upsertReminder 函数的去重逻辑

`upsertReminder` 函数会根据 `personId` + `isHandled=false` + `leaveId` 匹配已有提醒：
- 如果找到：更新提醒类型、日期和优先级
- 如果未找到：创建新提醒

### 3. 防重复保证

✅ **同一人同时只能有一条未处理提醒**  
✅ **休假结束后自动切换为常规逻辑**  
✅ **处理提醒后，基准日期更新为处理日期**  
✅ **定时任务不会重复创建已有提醒**

---

## 执行流程

### 定时任务执行步骤

```
┌───────────────────────────────────────────┐
│  每日定时任务执行流程（建议凌晨2点执行）   │
└───────────────────────────────────────────┘

1. 获取进程锁（防止多实例同时运行）
   ↓
2. 更新昨天休假结束的记录状态为 completed
   - updateCompletedLeaves()
   - 将 end_date = 昨天 且 status='active' 的记录改为 completed
   ↓
3. 获取所有用户的提醒阈值设置
   - getUserReminderSettings()
   - 返回 Map<userId, {urgentThreshold, suggestThreshold}>
   ↓
4. 更新已结束的休假状态（昨天之前结束的）
   - updateLeaveStatus()
   - 将 end_date < 昨天 且 status='active' 的记录改为 completed
   ↓
5. 统一处理所有提醒（核心逻辑）
   - processAllReminders(userSettingsMap)
   - 遍历所有人员
   - 确定基准日期
   - 按优先级判断是否创建提醒
   - 跳过已有未处理提醒的人员
   ↓
6. 输出执行统计
   - 更新了多少条休假记录
   - 创建了多少条新提醒
   - 更新了多少条提醒
   - 跳过了多少个已有提醒的人员
   ↓
7. 释放进程锁，关闭数据库连接
```

### 执行时间建议

- **推荐时间**：每天凌晨 2:00 AM（服务器时区）
- **执行频率**：每天一次
- **执行方式**：crontab 或 PM2 定时任务

**crontab 配置示例：**
```bash
0 2 * * * cd /path/to/backend && npm run cron:prod >> /var/log/reminder-cron.log 2>&1
```

**PM2 配置示例：**
```javascript
module.exports = {
  apps: [{
    name: 'reminder-cron',
    script: './scripts/reminder-cron.js',
    cron_restart: '0 2 * * *',
    autorestart: false,
  }]
}
```

---

## 数据库表结构说明

### persons 表
```sql
- id: 人员ID
- name: 姓名
- lastContactDate: 上次联系日期（基准日期的重要来源）
- createdAt: 添加日期（无联系记录时的基准日期）
- createdBy: 创建人ID（关联提醒阈值设置）
```

### leaves 表
```sql
- id: 休假ID
- personId: 人员ID
- startDate: 休假开始日期
- endDate: 休假结束日期
- status: 状态 (active/completed)
```

### reminders 表
```sql
- id: 提醒ID
- personId: 人员ID
- leaveId: 休假ID（可为null）
- reminderType: 提醒类型 (overdue/during/ending)
- reminderDate: 提醒日期
- priority: 优先级 (high/medium/low)
- isHandled: 是否已处理
```

### reminderSettings 表
```sql
- userId: 用户ID
- urgentThreshold: 紧急阈值（天）
- suggestThreshold: 建议阈值（天）
```

---

## 常见问题 FAQ

### Q1: 为什么取消了休假前提醒？
**A:** 休假开始前一天，人员还在单位，可以直接面对面沟通，不需要系统提醒。

### Q2: 短假为什么在第3天提醒？
**A:** 3-6天的短假不满足常规的7天阈值，但为了确保至少联系一次，设定在第3天提醒，这样即使是3天短假也能覆盖。

### Q3: 为什么休假结束前提醒要求至少5天？
**A:** 避免过于频繁的提醒。如果刚联系过（比如2天前），休假结束前不必再次提醒。5天是合理的平衡点。

### Q4: 如果用户不处理提醒，会一直累积吗？
**A:** 不会。每人同时只能有一条未处理提醒，定时任务会跳过已有提醒的人员。在特殊情况下（如休假结束前一天）可能会更新提醒日期。

### Q5: 休假期间联系了但未标记，还会继续提醒吗？
**A:** 会。系统依赖 `lastContactDate` 字段判断，如果用户联系后未在系统中标记，提醒会继续按原基准日期计算。建议用户及时更新联系记录。

### Q6: 2天的短假会有提醒吗？
**A:** 不会。短假提醒的最小时长是3天，2天及以下的假期不触发任何特殊提醒，只按常规阈值判断。

### Q7: 如果一个人有多段休假怎么办？
**A:** 系统只关注当前活跃的休假（status='active' 且当前日期在休假期间内）。一个人同时只能有一段活跃休假。
